#!/bin/bash
#
# kdiff-docker - Wrapper script to run kdiff in Docker
#
# Usage:
#   ./kdiff-docker [kdiff arguments]
#
# Example:
#   ./kdiff-docker -c1 prod-cluster -c2 staging-cluster -n myapp
#

set -e

# Configuration
IMAGE_NAME="kdiff:latest"
OUTPUT_DIR="./kdiff_output"
KUBECONFIG_PATH="${KUBECONFIG:-$HOME/.kube/config}"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if kubeconfig exists
if [ ! -f "$KUBECONFIG_PATH" ]; then
    echo -e "${YELLOW}Warning: kubeconfig not found at $KUBECONFIG_PATH${NC}"
    echo "Using KUBECONFIG environment variable or default location"
fi

# Create output directory if it doesn't exist
mkdir -p "$OUTPUT_DIR"

# Check if Docker is running
if ! docker info >/dev/null 2>&1; then
    echo -e "${YELLOW}Error: Docker is not running${NC}"
    exit 1
fi

# Check if image exists
if ! docker image inspect "$IMAGE_NAME" >/dev/null 2>&1; then
    echo -e "${YELLOW}Image $IMAGE_NAME not found. Building...${NC}"
    docker build -t "$IMAGE_NAME" .
fi

echo -e "${BLUE}Running kdiff in Docker container...${NC}"

# Run kdiff in container
docker run --rm -it \
    -v "$KUBECONFIG_PATH:/home/kdiff/.kube/config:ro" \
    -v "$(pwd)/$OUTPUT_DIR:/app/kdiff_output" \
    -e KUBECONFIG=/home/kdiff/.kube/config \
    "$IMAGE_NAME" "$@"

# Show success message if output was generated
if [ -f "$OUTPUT_DIR/latest/summary.json" ]; then
    echo -e "${GREEN}âœ“ Report generated successfully${NC}"
    echo -e "Output: $OUTPUT_DIR/latest/"
    
    # Open report if available
    if [ -f "$OUTPUT_DIR/latest/diff-details.html" ] && command -v open >/dev/null 2>&1; then
        echo -e "${BLUE}Opening report in browser...${NC}"
        open "$OUTPUT_DIR/latest/diff-details.html"
    fi
fi
